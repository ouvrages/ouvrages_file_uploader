#= require hamlcoffee
#= require jquery-fileupload
#= require_tree ./templates


fileCount = 0

$(document).ready ->
  $('form').bind 'submit', (e) ->
    if fileCount > 0
      return false
    else
      return true
  $(document).bind "items.item_added ready", ->
    $('.ofu-field').each ->
      $(this).find('.ofu-input').fileupload(
        autoUpload: true
        url: "<%= Rails.application.routes.url_helpers.file_upload_path() %>"
        uploadTemplateId: null
        downloadTemplateId: null
        paramName: 'files[]'
        progressall: (e, data) ->
          progress = parseInt(data.loaded / data.total * 100, 10)
          $(this).parents('.ofu-field').find('.bar').css('width', progress + "%").text(progress + "%")
      ).bind('fileuploadstart', (e, data) ->
        $(this).parents('.ofu-field').find('.ofu-files-container').empty()
        $(this).parents('.ofu-field').find('.ofu-files-container').append("<div class='progress'><div class='bar' style='width: 0;'></div></div>")
        return
      ).bind('fileuploaddone', (e, data) ->
        $(this).parents('.ofu-field').find('input[type=hidden]').val(data.result.files[0].id)
        if $(data.files[0].preview).is("canvas")
          $(this).parents('.ofu-field').parent().parent().find('.preview').html("<img src=" +data.result.files[0].url + "style='width: 300px; height: 188px;' />")
        else if $(data.files[0].preview).is("video")
          $(this).parents('.ofu-field').parent().parent().find('.preview').html("<video controls='controls' width='300' height='225' src="+data.result.files[0].url + "></video>")

        fileCount--
        return
      ).bind('fileuploadfail', (e, data) ->
        fileCount--
        return
      ).bind('fileuploadadd', (e, data) ->
        $(this).parents('.ofu-field').find('.ofu-files-container').empty()
        return
      )

$(window).bind 'beforeunload', ->
  if fileCount > 0
    console.log("PREVENT")
